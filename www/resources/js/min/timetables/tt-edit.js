"use strict";$(function(){var e="Tanárok és tantárgyak lekérése",t=$("table tbody td"),a={},n=_USRGRP,s="Egész osztály",o={"delete":[],add:[],week:""};if($("#select_tt").change(function(){var e=this,t=function(t){return!!t&&$.Dialog.wait(!1,"Átirányítás",function(){return window.location.href="/timetables/week/"+e.value})};return o["delete"].length||o.add.length?$.Dialog.confirm("Órarend váltás","Ha órarendet váltasz a módosításaid elvesznek, folytatod?",t):void t(!0)}),$(window).on("beforeunload",function(e){if(o["delete"].length||o.add.length){var t="Ha másik oldalra lépsz, a módosításaid elvesznek.";return e.returnValue=t,t}}),"user"==n||"editor"==n)return void $("tr td").addClass("notAdmin");$.ajax({method:"POST",url:"/timetables/getoptions",success:function(n){if("string"==typeof n)return console.log(n)===$(window).trigger("ajaxerror");if(n.status){var i=$(document.createElement("div")),r=$(document.createElement("div")),l=n.lessons&&n.lessons.length,d={},c={};$.each(n.teachers,function(e,t){c[t.id]=$.mk("optgroup").attr("label",t.name).appendTo(i)}),l&&$.each(n.lessons,function(e,t){(c[t.teacherid]||i).append($.mk("option").attr("value",t.id).attr("data-name",t.name).text(t.name))}),r.append($.mk("option").attr("value","0").text(s)),$.each(n.gthemes,function(e,t){d[t.id]=$.mk("optgroup").attr("label",t.name).appendTo(r)}),$.each(n.groups,function(e,t){(t.theme?d[t.theme]:r).append($.mk("option").attr("value",t.id).text(t.name))}),$.extend($.fn.powerTip.defaults,{placement:"se",mouseOnToPopup:!0,smartPlacement:!0,manual:!0});var p=$("#form-template").children();p.find(".groups").html(r.children().clone());var u=p.find(".lessons");l?u.html(i.children().clone()):u.attr("disabled",!0).html("<option disabled>(nincs hozzáadva tantárgy)</option>"),p.on("submit",function(e){e.preventDefault();var t=$(this),n=t.parent().attr("id").split("-").slice(1),i=parseInt(n[0]),r=parseInt(n[1]),l=$(".timet tbody tr").eq(r).children().eq(i),d=t.find("select"),c=d.filter("[name=groups]"),p=d.filter("[name=lessons]");if(p.is("[disabled]"))return $.Dialog.fail("Óra hozzáadása",'Nem található tantárgy az adatbázisban!<br>A folytatáshoz adj hozzá legalább egy tantárgyat a <a href="/lessons">Tantárgyak</a> menüpontban!');var u={group:c.val(),tantargy:p.val(),lesson:r+1,day:i};o.add.push(u),l.removeClass("empty"),l.hasClass("editing")&&(l.removeClass("editing"),$.powerTip.hide());var g=p.find("option:selected").attr("data-name"),m="#E1E4FA",h="",f=c.find("option:selected").text();$.each(a.lessons,function(e,t){g==t.name&&(m=t.color)}),f!=s&&(h=" ("+f+")"),l.append("<span class='lesson' style='background: "+m+"'>"+g+h+"<span class='del typcn typcn-times' data-ttid='#"+u.tantargy+"'></span></span>")}),t.each(function(){var e=$(this).find(".add"),t=e.parent(),a="add-"+t.index()+"-"+t.parent().index();e.data("powertipjq",p).powerTip({popupId:a}),$(".tooltips, #"+a).off("mouseenter mouseleave")}),a=n}else $.Dialog.fail(e)}}),t.on("click",function(e){e.preventDefault(),e.stopPropagation();var a=$(this),n=a.hasClass("editing");n||t.removeClass("editing"),a[(n?"remove":"add")+"Class"]("editing"),n||(a.find(".add").removeClass("typcn-minus").addClass("typcn-plus"),$.powerTip.hide())}).find(".add").on("click",function(e){e.stopPropagation();var t=$(this);return t.parent().hasClass("editing")?(t.hasClass("typcn-plus")?t.powerTip("show"):$.powerTip.hide(),void t.toggleClass("typcn-plus typcn-minus")):t.parent().trigger("click")}),$(document).on("click",function(e){var a=$(e.target);0===$(e.target).closest('[id^="add-"]').length&&0===a.closest(".lesson-field").length&&(t.removeClass("editing"),$.powerTip.hide())}),t.on("click",".del",function(){var e=$(this),t=e.attr("data-ttid"),a=e.parent(),n=a.parent();if("#"!=t.substring(0,1))o["delete"].push({id:t});else{var s=n.index(),i=n.parent().index()+1,r=!1,l=t.substring(1);if($.each(o.add,function(e,t){s==t.day&&i==t.lesson&&l==t.tantargy&&(r=e)}),r!==!1){var d=[];$.each(o.add,function(e,t){r!=e&&d.push(t)}),o.add=d}}2==n.children().length&&n.addClass("empty"),a.remove()});var i=function(){var e="Órarend mentése";o.week=$(".week").text(),$.Dialog.wait(e),$.ajax({method:"POST",url:"/timetables/save",data:o,success:function(t){return"string"==typeof t?console.log(t)===$(window).trigger("ajaxerror"):t.status?($.Dialog.success(e,t.message),void setTimeout(function(){location.reload()},2500)):$.Dialog.fail(e,t.message)}})};$(".sendbtn").on("click",function(){return 0==o["delete"].length?i():void $.Dialog.confirm("Órarend mentése","Arra készülsz, hogy mented az órarend változtatásait, köztük számos bejegyzés törlését.<br>Ezzel a törölt bejegyzésekhez tartozó adatok is elvesznek.<br>Biztos vagy benne, hogy végrehajtod a változtatásokat?",["Változtatások mentése","Visszalépés"],function(e){e&&i()})})});
//# sourceMappingURL=tt-edit.js.map
